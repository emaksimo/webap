% see also radar.m  where we make a day-by-day comparison of wind data
% here we compare U and V  parameters between Arome and Radar 
% altitudes in both records are normalized above the sea level
% to get the altitude of given grid location above the sea level, use :
% Radar wind measurement altitude [meters] is already relative to the sea level

clear all
close all

B = 16 ;
%%%%%%%%%%%%%%%%%%%% CONTROL parameters 
%%% Pianatoli radar position : 41.4722 N and 9.0656 E

%%% AROME-WMED coordinates closest to Pianatoli radar
latv = 41.48;  % alai = 242; % find(lati(:,1) == ala)
lonv = 9.08;   % aloi = 704; % find(loni(1,:) == alo)
slcm = 54 ; % altitude of model land surface above the sea level [meters]

%%% Levant (arome coordinates)
% latv = 43.03 ; % decimal degrees [N]
% lonv = 6.45 ; % decimal degrees [E]
% slcm = 12; 

%%% Candillargues (arome coordinates)
% latv = 43.6 ; % decimal degrees [N]
% lonv = 4.08 ; % decimal degrees [E]
% slcm = 1 ; 

alt = 3000; % the highest altitude for the comparison
year = 2012;
mo = 9;
ca = [-15 15] ; % horisontal wind speed color limits
% chemin2=(['/./media/elena/Transcend/Hymex/figures/monthly/']);   
% positionvector = [0.06 0.71 0.87 0.28 ; 0.06 0.39 0.87 0.28 ; 0.06 0.07 0.87 0.28 ]; 
positionvector = [0.06 0.7 0.43 0.29 ; 0.06 0.37 0.43 0.29 ; 0.06 0.04 0.43 0.29 ; 0.55 0.7 0.43 0.29 ; 0.55 0.37 0.43 0.29 ; 0.55 0.04 0.43 0.29 ]; 

if mo < 10 ; mmon = [num2str(0), num2str(mo)]; else ; mmon = num2str(mo); end
       
%%%%%%%%%%%%  brute RADAR data %%%%%%%%%%%%%%%%%%%%%%%%
if latv == 41.48 & lonv == 9.08    % Pianottoli (these are the arome grid coordinates closest to the Radar position)
    load(['/./media/elena/Transcend/Hymex/ASCII/Pianottoli_UHF_mh_01sept_15oct_normalized_20130906.mat']); % inDatesVec , inU , inV , inW , inZ , inZabl 
elseif latv == 43.03  &  lonv == 6.45     % Levant (arome coordinates)
    load(['/./media/elena/Transcend/Hymex/ASCII/Levant_UHF_mh_01sept_06nov2012_normalized.mat']);
elseif latv == 43.6 & lonv == 4.08 % Candillargues (arome coordinates)
    load(['/./media/elena/Transcend/Hymex/ASCII/Candi_UHF_mh_13sept_30nov2012_normalized.mat']);
end
clear AllData Q T logicalindex inSKEWw inASPT 
raz = max(find(inZ <= alt)+2) ; % radar altitude index within the matrix
ral =  inZ(raz) ; % the highest radar altitude 
TY = inDatesVec(:,4) +  (inDatesVec(:,5)./60);


%%%%%%%%%%   upload 3-hourly Radar and AROME-WMED data (same time and vertical resoltution)
%%%%%%%%%%% see radar_monthly.m script'
load(['/media/elena/Transcend/Hymex/AROME_WMED/matfile/3hourly_wind_profiles_radar_and _arome' num2str(mo) '_' num2str(latv), 'N', '_', num2str(lonv), 'E.mat']);
% AUT,AVT,AWST =  Arome-Wmed u-wind, v-wind and wind speed
%TAT,ZAT are the common time (3hourly) and altitude (above sea level) coordinates
% BL is a 3-hourly averaged bounday layer height (automatically deduced from Radar measurement)
% BL(mom) 3-hourly averaged radar bounday layer height      
% VRI(:,mom) & URI(:,mom) = 3-hourly averaged radar wind profiles interpolated into AROME resolution   
% WSPR  radar wind speed profile 3-hourly averaged
% WSPRI wind speed profile of radar wind interpolated into AROME coordinates (3-hourly averaged)

  
for day = B : eomday(year,mo);
    pb = day*8-7; % starting time
    pe = day*8+1;   % ending time

%%%%%%%%%%%%%%%%%%%%    U-wind component   %%%%%%%%%%%%%%
clf(figure(1))
figure(1);
set(gcf,'PaperType','A4','PaperUnits','centimeters','Units','centimeters','PaperSize',[27 27],'Position',[2 -1 27 27]); 
colormap(jet(64))
JET=get(gcf,'colormap');
    

%%% daily evolution of RADAR U wind component
subplot('position',positionvector(1,:)); hold on; 
pcolor((TAT(:,pb:pe)-(day-1)*24),ZAT(:,pb:pe),URI(:,pb:pe)); shading interp; hold on
caxis([ca(1) ca(2)]); box on; grid on ; hold on
set(gca,'xlim',[0 24],'xtick',0:3:24,'xticklabel',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
ylabel('altitude above sea level [meters]'); 
xlabel(['vertic interp 3h ave Radar U-wind [m/s], ' num2str(day) '/' num2str(mo) '/2012, ' num2str(latv), 'N', ' ', num2str(lonv), 'E'] ); 

hcb=colorbar('vertic');
u=get(hcb,'position') ;
set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 


% subplot('position',positionvector(3,:)); hold on;
% pcolor((TAT(:,pb:pe)-(day-1)*24),ZAT(:,pb:pe),minus(AUT(:,pb:pe),URI(:,pb:pe))); shading interp; hold on
% caxis([-10 10]); hold on
% set(gca,'xlim',[0 24],'xtick',0:3:24,'xticklabel',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
% ylabel('altitude above sea level [meters]');
% xlabel(['U-wind difference: Arome minus Radar [m/s], ' num2str(day) '/' num2str(mo) '/2012, ' num2str(latv), 'N', ' ', num2str(lonv), 'E'] ); 
% box on; grid on ;
% 
% hcb=colorbar('vertic');
% u=get(hcb,'position') ;
% set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 


%%%%%%%%%%%%%%%%%%%%    V-wind component   %%%%%%%%%%%%%% 
subplot('position',positionvector(2,:)); hold on;
pcolor((TAT(:,pb:pe)-(day-1)*24),ZAT(:,pb:pe),AVT(:,pb:pe)); shading interp; hold on
caxis([ca(1) ca(2)]); hold on
set(gca,'xlim',[0 24],'xtick',0:3:24,'xticklabel',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
ylabel('altitude above sea level [meters]');
xlabel(['AromeWMed V wind [m/s], ' num2str(day) '/' num2str(mo) '/2012, ' num2str(latv), 'N', ' ', num2str(lonv), 'E']); 
box on; grid on ;

hcb=colorbar('vertic');
u=get(hcb,'position') ;
% set(hcb,'position',[u(1)+0.07  u(2)  u(3)/2 u(4)],'ytick',[ca(1) : 5 : ca(2)]); 
set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 

subplot('position',positionvector(2,:)); hold on;    
pcolor((TAT(:,pb:pe)-(day-1)*24),ZAT(:,pb:pe),VRI(:,pb:pe)); shading interp; hold on
caxis([ca(1) ca(2)]); box on; grid on ; hold on
set(gca,'xlim',[0 24],'xtick',0:3:24,'xticklabel',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
ylabel('altitude above sea level [meters]');
xlabel(['vertic interp 3h ave Radar V-wind [m/s], ' num2str(day) '/' num2str(mo) '/2012, ' num2str(latv), 'N', ' ', num2str(lonv), 'E']); 

hcb=colorbar('vertic');
u=get(hcb,'position') ;
% set(hcb,'position',[u(1)+0.07  u(2)  u(3)/2 u(4)],'ytick',[ca(1) : 5 : ca(2)]); 
set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 

subplot('position',positionvector(3,:)); hold on;
pcolor((TAT(:,pb:pe)-(day-1)*24),ZAT(:,pb:pe),minus(AVT(:,pb:pe),VRI(:,pb:pe))); shading interp; hold on
caxis([-10 10]); hold on
set(gca,'xlim',[0 24],'xtick',0:3:24,'xticklabel',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
ylabel('altitude above sea level [meters]');
xlabel(['V-wind difference: Arome minus Radar [m/s], ' num2str(day) '/' num2str(mo) '/2012, ' num2str(latv), 'N', ' ', num2str(lonv), 'E']); 
box on; grid on ;

hcb=colorbar('vertic');
u=get(hcb,'position') ;
% set(hcb,'position',[u(1)+0.07  u(2)  u(3)/2 u(4)]); 
set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 

% set(findall(gcf,'type','text'),'fontsize',9)
% export_fig(fullfile(chemin2,['Vwind_arome_vs_radar_' num2str(mmon) '2012_', num2str(round(latv)), 'N', '_', num2str(round(lonv)), 'E_sealevcorrection.png']),'-painters','-nocrop')

keyboard
%%%%%%%%%%%%%%%%%%%%    Wind Speed   %%%%%%%%%%%%%%%%%%%%
clf (figure(3))
figure(3);
colormap(jet(64))
JET=get(gcf,'colormap');
set(gcf,'PaperType','A4','PaperUnits','centimeters','Units','centimeters','PaperSize',[15 27],'Position',[30 -1 15 27]); hold on  
% set(gcf,'PaperType','A4','PaperUnits','centimeters','Units','centimeters','PaperSize',[27 27],'Position',[2 -1 27 27]); 
subplot('position',positionvector(1,:)); hold on;
pcolor((TAT(:,pb:pe)-(day-1)*24),ZAT(:,pb:pe),AWST(:,pb:pe)); shading interp; hold on
caxis([ca(1) ca(2)]); hold on
set(gca,'xlim',[0 24],'xtick',0:3:24,'xticklabel',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
ylabel('altitude above sea level [meters]');
xlabel(['AromeWMed wind speed [m/s], ' num2str(day) '/' num2str(mo) '/2012, ' num2str(latv), 'N', ' ', num2str(lonv), 'E']); 
box on; grid on ;

hcb=colorbar('vertic');
u=get(hcb,'position') ;
% set(hcb,'position',[u(1)+0.07  u(2)  u(3)/2 u(4)],'ytick',[ca(1) : 5 : ca(2)]); 
set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 

subplot('position',positionvector(2,:)); hold on;    
pcolor((TAT(:,pb:pe)-(day-1)*24),ZAT(:,pb:pe),WSPRI(:,pb:pe)); shading interp; hold on
caxis([ca(1) ca(2)]); box on; grid on ; hold on
set(gca,'xlim',[0 24],'xtick',0:3:24,'xticklabel',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
ylabel('altitude above sea level [meters]');
xlabel(['vertic interp 3h ave Radar wind speed [m/s], ' num2str(day) '/' num2str(mo) '/2012, ' num2str(latv), 'N', ' ', num2str(lonv), 'E']);

hcb=colorbar('vertic');
u=get(hcb,'position') ;
% set(hcb,'position',[u(1)+0.07  u(2)  u(3)/2 u(4)],'ytick',[ca(1) : 5 : ca(2)]); 
set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 

subplot('position',positionvector(3,:)); hold on;    
pcolor((TAT(:,pb:pe)-(day-1)*24),ZAT(:,pb:pe),minus(AWST(:,pb:pe),WSPRI(:,pb:pe))); shading interp; hold on
caxis([-10 10]); box on; grid on ; hold on
set(gca,'xlim',[0 24],'xtick',0:3:24,'xticklabel',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
ylabel('altitude above sea level [meters]');
xlabel('Wind speed difference: AromeWMed minus Radar, [m/s]'); 

hcb=colorbar('vertic');
u=get(hcb,'position') ;
% set(hcb,'position',[u(1)+0.07  u(2)  u(3)/2 u(4)]); 
set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 
% set(findall(gcf,'type','text'),'fontsize',9)
% export_fig(fullfile(chemin2,['WSwind_arome_vs_radar_' num2str(mmon) '2012_', num2str(round(latv)), 'N', '_', num2str(round(lonv)), 'E_sealevcorrection.png']),'-painters','-nocrop')

keyboard

end % day of month

break
%%
%%%%%%%%%%%%    typical wind difference (error) between Arome and Radar     %%%%%%%%%%%%
%%% teh altitude in both data is normalized to the sea level
clear all
close all

%%% Pianatolli (arome coordinates)
latv = 41.48;  
lonv = 9.08;   

%%% Levant (arome coordinates)
% latv = 43.03 ; % decimal degrees [N]
% lonv = 6.45 ; % decimal degrees [E]

%%% Candillargues (arome coordinates)
% latv = 43.6 ; % decimal degrees [N]
% lonv = 4.08 ; % decimal degrees [E]

%%%%%%%%%%%%%%%%%%%%  cattenate the data for the entire common period :  Sept - Oct 2012
load(['/media/elena/Transcend/Hymex/AROME_WMED/matfile/3hourly_wind_profiles_radar_and _arome9' '_' num2str(latv), 'N', '_', num2str(lonv), 'E.mat']);
%     'AUT','AVT','AWST', 'WSPRI','VRI','URI','TAT','ZAT','data_description','latv','lonv','mo');
AUT9 = AUT;  AVT9 = AVT; AWST9 = AWST;
URI9 = URI; VRI9 = VRI ; WSPRI9 = WSPRI;
clear AUT AVT AWST URI VRI WSPRI

load(['/media/elena/Transcend/Hymex/AROME_WMED/matfile/3hourly_wind_profiles_radar_and _arome10' '_' num2str(latv), 'N', '_', num2str(lonv), 'E.mat']);   
AUT10 = AUT; AVT10 = AVT; AWST10 = AWST; 
URI10 = URI; VRI10 = VRI ; WSPRI10 = WSPRI;
clear AUT AVT AWST URI VRI WSPRI

if latv == 41.48
    AUT = [AUT9,AUT10];  AVT = [AVT9, AVT10]; AWST = [AWST9, AWST10];
    URI = [URI9,URI10]; VRI = [VRI9,VRI10]; WSPRI = [WSPRI9, WSPRI10];
else
    load(['/media/elena/Transcend/Hymex/AROME_WMED/matfile/3hourly_wind_profiles_radar_and _arome11' '_' num2str(latv), 'N', '_', num2str(lonv), 'E.mat']);   
    AUT11 = AUT; AVT11 = AVT; AWST11 = AWST; 
    URI11 = URI; VRI11 = VRI ; WSPRI11 = WSPRI;
    clear AUT AVT AWST URI VRI WSPRI
    
    AUT = [AUT9, AUT10, AUT11]; AVT = [AVT9, AVT10, AVT11]; AWST = [AWST9, AWST10, AWST11];
    URI = [URI9, URI10, URI11]; VRI = [VRI9, VRI10, VRI11]; WSPRI = [WSPRI9, WSPRI10, WSPRI11];
end

%%%%%%%  at each altitude: consider only those 3h moments where both radar and arome data is available
for i = 1:size(AUT,1) % altitude
    le(i,1) = length(URI(i,find(~isnan(URI(i,:)) & ~isnan(AUT(i,:)))))-1;
end
le(find(le == -1)) = NaN;

%%%% normalized wind difference at each altitude
dU(:,1) = sqrt(nansum((minus(AUT,URI)).^2,2)./le)  ;
dV(:,1) = sqrt(nansum((minus(AVT,VRI)).^2,2)./le) ;
dWS(:,1) = sqrt(nansum((minus(AWST,WSPRI)).^2,2)./le) ;

clf (figure(4))
figure(4)
h1 = plot(dU,ZAT(:,1),'r','linewidth',2,'linestyle','-.'); hold on 
h2 = plot(dV,ZAT(:,1),'r','linewidth',2); hold on 
h3 = plot(dWS,ZAT(:,1),'k','linewidth',2); hold 
set(gca,'ylim',[250 3100],'xlim',[1.78 3.2]);
ylabel('altitude above sea level [meters]');
xlabel('normalized wind difference [m/s]'); 
title({['V-wind (red plain) and U-wind (red dashed) difference'];['wind speed difference (black)'];[' Arome vs Radar at ' num2str(latv), '^oN', ' ', num2str(lonv), '^oE']}); 
box on; grid on ;



%%

 
%     %%% daily evolution of RADAR W wind component
%     subplot('position',positionvector(6,:)); hold on;    
%     pcolor(TR,ZR,WR); shading interp; hold on
%     caxis([cw(1) cw(2)]);
%     set(gca,'xlim',[0 24],'xtick',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); %,'yticklabel',inZ(1:4:56))
%     ylabel('altitude [meters]');
%     xlabel('radar W wind [m/s]'); 
    
    hcb=colorbar('horiz');
	u=get(hcb,'position') ;
	set(hcb,'position',[u(1)-0.18  u(2)-0.045  u(3)/1.5 u(4)/2]); 
    f=get(hcb,'xlabel');
%	set(f,'string', {'wind speed, U, V [m/s]'},'fontsize',8,'FontWeight','demi');
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
    %%%% plot the hourly average radar profile 
%     figure(2);
%     set(gcf,'PaperType','A4'); %,'PaperUnits','centimeters','Units','centimeters','PaperSize',[20 28],'Position',[1 1 20 28]); 
%     hold on
%       
%     tt = inDatesVec(radt,4:5);
%     dv = inV(radt,1:raz);
%     du = inU(radt,1:raz);
%     
%     for hh = 0 : 23
%         vv(hh+1,:) = nanmean(dv(find(tt(:,1) == hh),1:raz),1);   
%         uu(hh+1,:) = nanmean(du(find(tt(:,1) == hh),1:raz),1);   
%     end
%     
%     
%     %%% U component hourly (both radar and erai)
%     subplot('position',[0.54 0.05 0.45 0.9]); hold on;
%     %%% plot 1-h average radar profile
%     ct = 1; ht = 1 ;
%     for hh = 0 : 24
%         RGB = JET(ceil(ht),:);
%         if hh < 23
%             h2 = plot(vv(hh+1,:)',inZ(1:raz),'color',[RGB(1),RGB(2),RGB(3)],'linewidth',2); hold on 
%         end
%         
% %         if hh == 0 | hh == 6 | hh == 18 | hh == 24 
% %             h3 = plot(V(eaz:16,modt(ct)),Z(eaz:16,modt(ct)),'color',[RGB(1),RGB(2),RGB(3)],'linewidth',2,'linestyle','-.'); hold on % ERAI data
% %             ct = ct + 1 ;
% %         end   
%         ht = ht + 2.5 ;
%     end
%     
%     %%% plot each 3-min profile
% %     h2 = plot(nanmean(inV(radt(1) : radt(length(radt)),1:12),1),inZ(1:12),'k','linewidth',2); hold on 
%     
%     %%% plot 6-hourly ERAI profile
% %     h3 = plot(V(8:16,modt),Z(8:16,modt),'g','linewidth',2); hold on % ERAI data
%     set(gca,'xlim',[ca(1) ca(2)],'ylim',[0 alt],'ytick',[0:250:alt]); 
%     grid on
%     ylabel('altitude [meters]');
%     xlabel('V wind : radar (plain) and erai (dashed) m/s]'); 
%     
%     %%%% V component hourly (both radar and erai)
%     subplot('position',[0.05 0.05 0.45 0.9]); hold on;
%     %%% plot 1-h average radar profile
%     ct = 1; ht = 1 ;
%     for hh = 0 : 24
%         RGB = JET(ceil(ht),:);
%         if hh < 23
%             h2 = plot(uu(hh+1,:)',inZ(1:raz),'color',[RGB(1),RGB(2),RGB(3)],'linewidth',2); hold on 
%         end
% %         if hh == 0 | hh == 6 | hh == 18 | hh == 24 
% %             h3 = plot(U(eaz:16,modt(ct)),Z(eaz:16,modt(ct)),'color',[RGB(1),RGB(2),RGB(3)],'linewidth',2,'linestyle','-.'); hold on % ERAI data
% %             ct = ct + 1 ;
% %         end   
%         ht = ht + 2.5 ;
%     end
    
%     %%% plot each 3-min profile
% %     h2 = plot(nanmean(inV(radt(1) : radt(length(radt)),1:12),1),inZ(1:12),'k','linewidth',2); hold on 
%     
%     %%% plot 6-hourly ERAI profile
% %     h3 = plot(V(8:16,modt),Z(8:16,modt),'g','linewidth',2); hold on % ERAI data
%     set(gca,'xlim',[ca(1) ca(2)],'ylim',[0 alt],'ytick',[0:250:alt]); 
%     grid on
%     ylabel('altitude [meters]');
%     xlabel('U wind : radar (plain) and erai (dashed) [m/s]'); 
%     
    figure(3);
    set(gcf,'PaperType','A4','PaperUnits','centimeters','Units','centimeters','PaperSize',[15 27],'Position',[30 1 15 27]); hold on
    subplot('position', [0.07 0.7 0.83 0.29]); hold on;    
    pcolor(TR,ZR,ER); shading interp; hold on
    caxis([0 0.001]);
    set(gca,'xlim',[0 24],'xtick',0:3:24,'ylim',[0 alt],'ytick',0:250:alt); 
    ylabel('altitude [meters]');
    xlabel('epsilon [m^2/s^3]'); 
    h5 = plot(TR(1,:),BL,'k'); hold on
    grid on; box on;
    hcb=colorbar('vertic');
	u=get(hcb,'position') ;
	set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)/1.05]); 
    
    subplot('position', [0.07 0.37 0.83 0.29]); hold on;    
    pcolor(TR,ZR,CR); shading interp; hold on
    caxis([0 10^(-12)]);
    set(gca,'xlim',[0 24],'xtick',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
    ylabel('altitude [meters]');
    xlabel('refractive index [m^{-2/3}]'); 
    h5 = plot(TR(1,:),BL,'k'); hold on
    grid on; box on;
    
    hcb=colorbar('vertic');
	u=get(hcb,'position') ;
	set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 
    
    subplot('position', [0.07 0.04 0.83 0.29]); hold on; 
%     pcolor(TR,ZR,STDRW); shading interp; hold on
%     caxis([1 5]);
%     set(gca,'xlim',[0 24],'xtick',0:3:24,'ylim',[0 alt],'ytick',[0:250:alt]); 
%     ylabel('altitude [meters]');
%     xlabel('2 std of W-component [m/s]'); 
%     h5 = plot(TR(1,:),BL,'k'); hold on
%     grid on; box on;
%     hcb=colorbar('vertic');
% 	u=get(hcb,'position') ;
% 	set(hcb,'position',[u(1)+0.12  u(2)  u(3)/1.7 u(4)]); 
    
     

    keyboard
% end

